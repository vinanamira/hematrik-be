<h1 align="center" style="font-weight: bold;">Hematrik</h1>

<p align="center">
 <a href="#tech">Technologies</a> ‚Ä¢ 
 <a href="#started">Getting Started</a> ‚Ä¢ 
 <a href="#routes">API Endpoints</a> 
</p>

<p align="center">
    <b>Hematrik is an IoT-based energy monitoring system that enables the real-time monitoring and control of electronic devices (lights, dispensers, and AC) through MQTT data. Backend development uses Express.js and MySQL, and implements an automatic notification feature when devices are turned on outside of working hours. The backend is deployed using PM2 and connected to an external MQTT broker. This system has been implemented in the lecturer's room at the University of Mandiri Subang.   </b>
</p>

<h2 id="technologies">Technology</h2>

- Express.js
- MySQL
- MQTT Explorer
- Cron-job

<h2 id="started">Getting started</h2>

<h3>Prerequisites</h3>

Here you list all prerequisites necessary for running the project:

- [Express.js](https://expressjs.com/en/starter/hello-world.html)

## How to use

1. **Clone the Repository:**

   ```bash
   git clone https://github.com/vinanamira/hematrik-be.git
   ```
   
2. **Enter the Project Directory:**

   After the cloning process is complete, enter the folder of the newly created project:

   ```bash
   cd hematrik-be
   ```

3. **Set the database key:**

   Set the environment variable in the project: Create a `.env` file at the root of the project and add the following line

    ```bash
   DB_HOST=<url_db_host>
   DB_USER=<db_username>
   DB_PASSWORD=<db_password>
   DB_NAME=<db_name>
   DB_PORT=<db_port>
   PORT=5000
   ```
    
4. **Set the MQTT key:**

   Set the environment variable in the project: Create a `.env` file at the root of the project and add the following line

    ```bash
    MQTT_HOST=<url_mqtt_host>
    MQTT_PORT=<mqtt_port>
    MQTT_USERNAME=<mqtt_username>
    MQTT_PASSWORD=<mqtt_password>
    MQTT_TOPICS=<mqtt_topics>
    MQTT_CLIENTID=<your_mqtt_clientid>
   ```
    
5. **Set the API key:**

   Set `API_KEY` the environment variable in the project: Create a `.env` file at the root of the project and add the following line

    ```bash
   API_KEY=<your_api_key>
   ```

6. **Install dependencies:**

   Run in the project root:

   ```bash
   npm install
   ```

7. **Run the app:**

   ```bash
   npm start
   ```

   The app will be available at [`http://127.0.0.1:5000`](http://127.0.0.1:5000).

<h2 id="routes">üìç API Endpoints</h2>

Here is a list of the main API routes with the expected request bodies.
‚Äã
| Route               | Description                                          
|----------------------|-----------------------------------------------------
| <kbd>GET /api/devices</kbd>     | Taking a list of all devices (lights, AC, dispensers) registered in the system [response details](#get-all-device)
| <kbd>POST /api/device/:device_id/control</kbd>     | Sending a command to change the status of a specific device [request details](#post-device-detail)
| <kbd>GET /api/logs</kbd>     | Taking the history of electricity usage logs[response details](#get-logs-detail)
| <kbd>GET /api/notifications</kbd>     | Taking the list of automatic notifications generated by the system [response details](#get-notification-detail)

<h2>Devices</h2>

<h3 id="#get-all-device">GET /api/devices</h3>

**AUTHORIZATION**

```
Key : x-api-key
Value : <value>
```

**RESPONSE**
```json
[
  {
    "device_id": "4B8A13",
    "device_name": "AC",
    "device_type": "ac",
    "mqtt_topic": "EMON25/tele/4B8A13",
    "location": "Universitas Mandiri Subang, Ruang Dosen Fakultas Teknik",
    "status": "offline"
  },
  {
    "device_id": "75AA3A",
    "device_name": "Dispenser",
    "device_type": "dispenser",
    "mqtt_topic": "EMON25/tele/75AA3A",
    "location": "Universitas Mandiri Subang, Ruang Dosen Fakultas Teknik",
    "status": "offline"
  },
  {
    "device_id": "939788",
    "device_name": "Lampu",
    "device_type": "lampu",
    "mqtt_topic": "EMON25/tele/939788",
    "location": "Universitas Mandiri Subang, Ruang Dosen Fakultas Teknik",
    "status": "online"
  }
]
```


<h3 id="post-device-detail">POST /api/device/:device_id/control</h3>

**AUTHORIZATION**

```
Key : x-api-key
Value : <value>
```

**PATH VARIABLES**

```
device_id : 75AA3A
```

**REQUEST**

```json
{
    "state": "ON"
}
```


**RESPONSE**
```json
{
  "message": "Perangkat 75AA3A dikontrol ‚Üí ON"
}
```
<h2>Electricity Consumption</h2>

<h3 id="get-logs-detail">GET /api/logs</h3>

**AUTHORIZATION**

```
Key : x-api-key
Value : <value>
```

**RESPONSE**
```json
[
  {
    "log_id": 1135,
    "device_id": "4B8A13",
    "total_kwh": "484.692",
    "today_kwh": "77.128",
    "yesterday_kwh": "1.702",
    "power": 21648,
    "apparent_power": 109526,
    "reactive_power": 65535,
    "factor": "0.20",
    "voltage": "218.00",
    "current": "502.87",
    "time_recorded": "2025-04-21T08:46:30.000Z"
  },
  {
    "log_id": 1134,
    "device_id": "75AA3A",
    "total_kwh": "4.519",
    "today_kwh": "0.000",
    "yesterday_kwh": "0.000",
    "power": 0,
    "apparent_power": 0,
    "reactive_power": 0,
    "factor": "0.00",
    "voltage": "226.00",
    "current": "0.00",
    "time_recorded": "2025-04-21T08:44:18.000Z"
  },
  {
    "log_id": 1133,
    "device_id": "4B8A13",
    "total_kwh": "484.109",
    "today_kwh": "76.545",
    "yesterday_kwh": "1.702",
    "power": 21484,
    "apparent_power": 107967,
    "reactive_power": 65535,
    "factor": "0.20",
    "voltage": "214.00",
    "current": "504.28",
    "time_recorded": "2025-04-21T08:42:30.000Z"
  },
]
```

<h2>Notification<//h2>

<h3 id="get-notification-detail">GET /api/notifications</h3>

**AUTHORIZATION**

```
Key : x-api-key
Value : <value>
```


**RESPONSE**
```json
[
  {
    "notif_id": 3,
    "device_id": "4B8A13",
    "notif_message": "AC masih menyala pada pukul 17.00",
    "is_sent": 0,
    "notif_time": "2025-04-21T10:00:00.000Z"
  }
]
```
